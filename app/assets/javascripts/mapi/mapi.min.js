
var Mapi;var __mapi;var __map;if(typeof(Number.prototype.toRad)==="undefined"){Number.prototype.toRad=function(){return this*Math.PI/180;}}
function lineIntersect(cx,cy,cr,x1,y1,x2,y2){var n=Math.abs((x2-x1)*(y1-cy)-(x1-cx)*(y2-y1));var d=Math.sqrt((x2-x1)*(x2-x1)+(y2-y1)*(y2-y1));var dist=n/d;if(dist>cr)return false;var d1=Math.sqrt((cx-x1)*(cx-x1)+(cy-y1)*(cy-y1));if((d1-cr)>d)return false;var d2=Math.sqrt((cx-x2)*(cx-x2)+(cy-y2)*(cy-y2));if((d2-cr)>d)return false;return true;}
function loadScript(url,callback)
{if(url===''){callback();return;}
var head=document.getElementsByTagName('head')[0];var script=document.createElement('script');script.type='text/javascript';script.src=url;script.onreadystatechange=callback;script.onload=callback;head.appendChild(script);}
function loadTxtFile(file,callback){var xmlhttp;if(window.XMLHttpRequest)
xmlhttp=new XMLHttpRequest();else
xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");xmlhttp.onreadystatechange=function(){if(xmlhttp.readyState==4&&xmlhttp.status==200)
callback(xmlhttp.responseText);}
xmlhttp.open("GET",file,true);xmlhttp.send();}
var __mapiDir="./mapi/";var __mapiIcons=new Object();var __loadedJQ=false;var __loadedOL=false;var __loadedMap=false;var transportURL;Mapi={Load:function(opts,callback){if(typeof opts.dir==='undefined'){alert("Please define 'dir' eg. Mapi.Load({dir:'mapi/'}, function() {} );");return;}
if(typeof opts.loadJQuery==='undefined')
opts.loadJQuery=true;__mapiDir=opts.dir;loadScript("http://openlayers.org/api/OpenLayers.js",function(){loadScript(opts.loadJQuery?"http://code.jquery.com/jquery-1.7.2.min.js":"",function(){loadTxtFile(__mapiDir+"icons/config.txt",function(txt){var lines=txt.split("\n");for(var i=0;i<lines.length;++i){var l=lines[i];if(l.indexOf("//")==0)
continue;var icon=l.split(" ");if(icon.length==6){__mapiIcons[icon[0]]={ext:icon[1],w:parseFloat(icon[2]),h:parseFloat(icon[3]),x:parseFloat(icon[4]),y:parseFloat(icon[5])};}}
if(!__loadedMap){loadMapi();transportURL=function(url,callback){url=__mapiDir+"transport.php?method=get&url="+url;$.get(url,callback);};callback();__loadedMap=true;}});});});}}
function loadMapi(){OpenLayers.Control.Click=OpenLayers.Class(OpenLayers.Control,{defaultHandlerOptions:{'single':true,'double':false,'pixelTolerance':0,'stopSingle':false,'stopDouble':false},initialize:function(options){this.handlerOptions=OpenLayers.Util.extend({},this.defaultHandlerOptions);OpenLayers.Control.prototype.initialize.apply(this,arguments);this.handler=new OpenLayers.Handler.Click(this,{'click':this.trigger},this.handlerOptions);},trigger:function(e){var lonlat=__map.getLonLatFromPixel(e.xy);lonlat.transform(__map.getProjectionObject(),__map.projection);var loc=new Mapi.Loc(lonlat.lat,lonlat.lon);for(var i=0;i<__mapi._events.length;++i){__mapi._events[0].callback(loc);}}});Mapi={Loc:function(lat,lon){this.lon=lon;this.lat=lat;this.ol=function(){var lonlat=new OpenLayers.LonLat(this.lon,this.lat);lonlat.transform(__map.projection,__map.getProjectionObject());return lonlat;}
this.px=function(){return __map.getLayerPxFromViewPortPx(__map.getPixelFromLonLat(this.ol()));}
this.add=function(lat,lon){this.lat+=lat;this.lon+=lon;}
this.clone=function(){return new Mapi.Loc(this.lat,this.lon);}
this.dist=function(loc){var R=6371;var lat1=this.lat.toRad();var lon1=this.lon.toRad();var lat2=loc.lat.toRad();var lon2=loc.lon.toRad();var d=Math.acos(Math.sin(lat1)*Math.sin(lat2)+
Math.cos(lat1)*Math.cos(lat2)*Math.cos(lon2-lon1))*R;return d;}
this.equals=function(loc){return this.lat==loc.lat&&this.lon==loc.lon;}},Icon:function(url,width,height,offsetx,offsety){this.url=url;this.width=width;this.height=height;this.offsetx=offsetx;this.offsety=offsety;this.icon=new OpenLayers.Icon(url,new OpenLayers.Size(width,height),new OpenLayers.Pixel(-width*offsetx,-height*offsety));this.ol=function(){return this.icon;}},Marker:function(loc,icon,controller){this.loc=loc;var t=typeof icon;if(t==="string"){var dir=icon.slice(0,icon.lastIndexOf("/")+1);var ic=__mapiIcons[dir];var url=__mapiDir+"icons/"+icon+ic.ext;this.marker=new OpenLayers.Marker(loc.ol(),new Mapi.Icon(url,ic.w,ic.h,ic.x,ic.y).ol());}
else if(t==="undefined")
this.marker=new OpenLayers.Marker(loc.ol());else
this.marker=new OpenLayers.Marker(loc.ol(),icon.ol().clone());this.ol=function(){return this.marker;}
this.controller=controller;this.moveTo=function(loc){this.loc=loc;this.marker.moveTo(loc.px());}
this.update=function(){this.marker.moveTo(this.loc.px());}},Controller:function(){this.marker;this.update=function(delta){}},Route:function(){this.points=new Array();this.description="";this.distance=0;this.traveltime=0;this.markerFrom;this.markerTo;this.moveByDist=function(dist){this.hide();for(var i=1;i<this.points.length;++i){var l1=this.points[i-1];var l2=this.points[i];var d=l1.dist(l2);if(d>dist){var r=dist/d;l1.lat=l1.lat+(l2.lat-l1.lat)*r;l1.lon=l1.lon+(l2.lon-l1.lon)*r;break;}
else{dist-=d;this.points.shift();--i;}}
this.show();return this.points[0];}
this.setMarkerFrom=function(icon,controller){if(this.points.length<0)
return;this.markerFrom=new Mapi.Marker(this.points[0],icon,controller);}
this.setMarkerTo=function(icon,controller){if(this.points.length<0)
return;this.markerTo=new Mapi.Marker(this.points[this.points.length-1],icon,controller);}
this._line;this.style={strokeColor:'#0000ff',strokeOpacity:0.5,strokeWidth:5};this.show=function(){var points=new Array();for(var i=0;i<this.points.length;++i){var loc=this.points[i];var ol=loc.ol();points.push(new OpenLayers.Geometry.Point(ol.lon,ol.lat));}
this._line=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.LineString(points),null,this.style);__mapi.layerRoutes.addFeatures([this._line]);if(typeof this.markerFrom!=='undefined'){console.log('stuff');__mapi.addMarker(this.markerFrom);}
if(typeof this.markerTo!=='undefined')__mapi.addMarker(this.markerTo);}
this.hide=function(){if(typeof this._line!=='undfined'){__mapi.layerRoutes.removeFeatures([this._line]);delete this._line;}
if(typeof this.markerFrom!=='undefined'){__mapi.removeMarker(this.markerFrom);delete this.markerFrom;}
if(typeof this.markerTo!=='undefined'){__mapi.removeMarker(this.markerTo);delete this.markerTo;}}},Node:function(node){this.id=node.getAttributeNode("id").nodeValue;this.version=node.getAttributeNode("version").nodeValue;this.changeset=node.getAttributeNode("changeset").nodeValue;this.lat=node.getAttributeNode("lat").nodeValue;this.lon=node.getAttributeNode("lon").nodeValue;this.user=node.getAttributeNode("user").nodeValue;this.uid=node.getAttributeNode("uid").nodeValue;this.visible=node.getAttributeNode("visible").nodeValue;this.timestamp=node.getAttributeNode("timestamp").nodeValue;this.loc=new Mapi.Loc(this.lat,this.lon);},Way:function(way,nodes){this.id=way.getAttributeNode("id").nodeValue;this.id=way.getAttributeNode("id").nodeValue;this.visible=way.getAttributeNode("visible").nodeValue;this.timestamp=way.getAttributeNode("timestamp").nodeValue;this.version=way.getAttributeNode("version").nodeValue;this.changeset=way.getAttributeNode("changeset").nodeValue;this.user=way.getAttributeNode("user").nodeValue;this.uid=way.getAttributeNode("uid").nodeValue;var tags=way.getElementsByTagName("tag");this.tags=new Object();for(var i=0;i<tags.length;++i){var key=tags[i].getAttributeNode("k").nodeValue;var val=tags[i].getAttributeNode("v").nodeValue;this.tags[key]=val;}
this.nodes=new Array();if(typeof nodes!=='undefined'){var nds=way.getElementsByTagName("nd");for(var n=0;n<nds.length;++n){var ref=nds[n].getAttributeNode("ref").nodeValue;this.nodes.push(nodes[ref]);}}
this._line;this.style={strokeColor:'#0000ff',strokeOpacity:0.5,strokeWidth:5};this.show=function(){var points=new Array();for(var i=0;i<this.nodes.length;++i){var ol=this.nodes[i].loc.ol();points.push(new OpenLayers.Geometry.Point(ol.lon,ol.lat));}
this._line=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.LineString(points),null,this.style);__mapi.layerRoutes.addFeatures([this._line]);}
this.hide=function(){if(typeof this._line!=='undfined'){__mapi.layerRoutes.removeFeatures([this._line]);delete this._line;}}},Map:function(opts){var el=$("#"+opts.div);el.css("position","relative");el.css("background","#f1f1f1 url("+__mapiDir+"bg/default.png) repeat");el=$("<div></div>");el.css("position","absolute");el.css("width","100%");el.css("height","20px");el.css("top","0px");el.css("z-index","1000");el.css("background","#000000");el.css("opacity","0.75");el.css("filter","alpha(opacity=75)");el.appendTo("#"+opts.div);el=$("<div>Mapi | <a href='http://playdev.co.za' target='_blank'><font color='white'>Play Dev</font></a></div>");el.css("position","absolute");el.css("color","white");el.css("top","0px");el.css("right","10px");el.css("z-index","1000");el.appendTo("#"+opts.div);if(typeof opts.theme==="undefined")
opts.theme="default";$('head').append('<link rel="stylesheet" type="text/css" href="'+__mapiDir+"themes/"+opts.theme+'/style.css">');__mapi=this;var panZoomBar=new OpenLayers.Control.PanZoomBar({slideRatio:.25});this.map=__map=new OpenLayers.Map(opts.div,{controls:[panZoomBar,new OpenLayers.Control.Navigation(),new OpenLayers.Control.ArgParser(),new OpenLayers.Control.Attribution()]});this.osm=new OpenLayers.Layer.OSM("OpenStreetMap",null,{transitionEffect:"resize",attribution:""});this.map.addLayer(this.osm);this.map.zoomToMaxExtent();var control=new OpenLayers.Control();OpenLayers.Util.extend(control,{draw:function(){this.box=new OpenLayers.Handler.Box(control,{"done":this.notice},{keyMask:OpenLayers.Handler.MOD_SHIFT});this.box.activate();},notice:function(bounds){}});this.map.addControl(control);this.ol=function(){return this.map;}
this.setCenter=function(loc,zoom,dragging,forceZoomChange){this.map.setCenter(loc.ol(),zoom,dragging,forceZoomChange);}
this.zoomToMaxExtent=function(){this.map.zoomToMaxExtent();}
this.getRoute=function(from,to,callback,vehicle){var url="http://www.yournavigation.org/api/1.0/gosmore.php&format=geojson";if(typeof vehicle==="undefined")
vehicle="motorcar";url+="&v="+vehicle;url+="&instructions=1";url+="&flat="+from.lat;url+="&flon="+from.lon;url+="&tlat="+to.lat;url+="&tlon="+to.lon;url+="&method=get";transportURL(url,function(data){var route=new Mapi.Route();for(var i=0;i<data.coordinates.length;++i){var loc=new Mapi.Loc(data.coordinates[i][1],data.coordinates[i][0]);if(i==0&&loc.dist(from)>0.1)
return;route.points.push(loc);}
route.description=data.properties.description;route.distance=parseFloat(data.properties.distance);route.traveltime=parseFloat(data.properties.traveltime);callback(route);});}
this.getClosestRoadLoc=function(loc,callback){var area=0.001;var from=new Array();from[0]=new Mapi.Loc(loc.lat-area,loc.lon);from[1]=new Mapi.Loc(loc.lat+area,loc.lon);from[2]=new Mapi.Loc(loc.lat,loc.lon-area);from[3]=new Mapi.Loc(loc.lat,loc.lon+area);var i=0;var getRoute=this.getRoute;var cb=function(data){if(data.properties.distance>0){var c=data.coordinates;c=c[c.length-1];data.loc=new Mapi.Loc(c[1],c[0]);data.success=true;callback(data);return;}
if(++i<from.length)
getRoute(from[i],loc,cb);else{data.success=false;return callback(data);}}
getRoute(from[i],loc,cb);}
this.getClosestWay=function(loc,callback){var area=0.001;var left=loc.lon-area;var right=loc.lon+area;var bottom=loc.lat-area;var top=loc.lat+area;this.osmGetMap(left,bottom,right,top,function(data){var ways=data.ways;for(var way in ways){var w=ways[way];if(typeof w.tags['name']==='undefined')
continue;for(var i=0;i<w.nodes.length;++i){if(i==0)
continue;var node1=w.nodes[i];var node2=w.nodes[i-1];if(lineIntersect(loc.lon,loc.lat,0.0001,node1.lon,node1.lat,node2.lon,node2.lat)){callback(w);return;}}}
callback(false);});}
this.osmAPI="http://api.openstreetmap.org/api/0.6/";this.osmGetMap=function(left,bottom,right,top,callback){var url=this.osmAPI+"map&bbox="+left+","+bottom+","+right+","+top;transportURL(url,function(xml){var nodes=new Object();var ways=new Object();var N=xml.getElementsByTagName("node");for(var i=0;i<N.length;++i){var n=new Mapi.Node(N[i]);nodes[n.id]=n;}
var W=xml.getElementsByTagName("way");for(var i=0;i<W.length;++i){var w=new Mapi.Way(W[i],nodes);ways[w.id]=w;}
var data=new Object();data.nodes=nodes;data.ways=ways;callback(data);});}
this.osmGetNode=function(id,callback){var url=this.osmAPI+"node/"+id;transportURL(url,function(xml){var n=xml.getElementsByTagName("node");if(n.length==0){callback(false);return;}
callback(new Mapi.Node(n[0]));});}
this.osmGetWay=function(id,callback){var url=this.osmAPI+"way/"+id;transportURL(url,function(xml){var w=xml.getElementsByTagName("way");if(w.length==0){callback(false);return;}
callback(new Mapi.Way(w[0]));});}
this.osmGetWayFull=function(id,callback){var url=this.osmAPI+"way/"+id+"/full";transportURL(url,function(xml){var w=xml.getElementsByTagName("way");if(w.length==0){callback(false);return;}
var way=new Mapi.Way(w[0]);way.nodes=new Array();var nds=xml.getElementsByTagName("node");for(var i=0;i<nds.length;++i){var node=new Mapi.Node(nds[i]);way.nodes.push(node);}
callback(way);});}
this.layerRoutes=new OpenLayers.Layer.Vector("routes");this.map.addLayer(this.layerRoutes);this.sort=true;this.layerMarkers=new OpenLayers.Layer.Markers("markers");this.map.addLayer(this.layerMarkers);this.markers=new Array();this.addMarker=function(marker){this.markers.push(marker);this.layerMarkers.addMarker(marker.ol());}
this.clearMarkers=function(){this.markers=new Array();this.layerMarkers.clearMarkers();}
this.removeMarker=function(marker){this.markers=this.markers.splice(this.markers.indexOf(marker),1);this.layerMarkers.removeMarker(marker.ol());}
this.update=function(delta){if(this.sort){this.layerMarkers.clearMarkers();this.markers.sort(function(a,b){return b.loc.lat-a.loc.lat});}
for(var i=0;i<this.markers.length;++i){var m=this.markers[i];if(typeof m.controller!=="undefined"){m.controller.update(m,delta);m.update();}
if(this.sort)
this.layerMarkers.addMarker(m.ol());}}
window.setInterval("__mapi.update(100/1000)",100);var click=new OpenLayers.Control.Click();this.map.addControl(click);click.activate();this._events=new Array();this.addEvent=function(type,callback){var ev=new Object();ev.type=type;ev.callback=callback;this._events.push(ev);}}}}